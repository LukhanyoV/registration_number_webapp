name: NodeJS CI with PostgreSQL

on: push: branches: [ master ] pull_request: branches: [ master ]

jobs: build:

runs-on: ubuntu-latest

strategy:
  matrix:
    node-version: [12.x, 14.x, 16.x]
    # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
services:
  postgres:
    image: postgres:latest
    env: 
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test123
      POSTGRES_DB: registrations_test
    ports:
    - 5432:5432
    # Set health checks to wait until postgres has started
    options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5
    
steps:
- uses: actions/checkout@v3
- name: Install dependencies
  run: npm install
- name: create postgresql tables
  run: PGPASSWORD=test123 psql -h localhost -U test -d registrations_test -a -f ./db/tables.sql
- name: run tests with postgresql
  run:
    npm test
  env:
    DATABASE_URL: postresql://test:test123@localhost:5432/registrations_test